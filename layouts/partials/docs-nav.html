{{ $currentNode := . }}
{{ $showvisitedlinks := .Site.Params.showVisitedLinks -}}

{{ if eq .Site.Params.ordersectionsby "title"}}
  {{ range .Site.Home.Sections.ByTitle}}
  {{ template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks}}
  {{ end}}
{{ else}}
  {{ range .Site.Home.Sections.ByWeight}}
  {{ template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks}}
  {{ end}}
{{ end}}

<!-- templates -->
{{ define "section-tree-nav" }}
{{ $showvisitedlinks := .showvisitedlinks }}
{{ $currentNode := .currentnode }}
 {{ with .sect}}
  {{ if and .IsSection (or (not .Params.hidden) $.showhidden)}}
    {{ safeHTML .Params.head}}
    <li data-nav-id="{{.URL}}" class="dd-item
        {{ if .IsAncestor $currentNode}} parent{{end}}
        {{ if eq .URL $currentNode.URL}} active{{end}}
        {{ if .Params.alwaysopen}} alwaysopen{{end -}}
        ">
      <a href="{{ .RelPermalink}}">
        <span>{{safeHTML .Params.Pre}}{{.Title}}{{safeHTML .Params.Post}}</span>

        {{ $numberOfPages := (add (len .Pages) (len .Sections)) }}
        {{ if ne $numberOfPages 0 }}
          {{ if or (.IsAncestor $currentNode) (.Params.alwaysopen) }}
            <i class="material-icons">keyboard_arrow_down</i>
          {{ else -}}
            <i class="material-icons">keyboard_arrow_right</i>
          {{ end}}
        {{ end}}

        {{ if $showvisitedlinks}}<i class="material-icons">check</i>{{end}}
      </a>
      {{ if ne $numberOfPages 0 }}
        <ul class="sub-pages">
          {{ .Scratch.Set "pages" .Pages }}
          {{ if .Sections}}
          {{ .Scratch.Set "pages" (.Pages | union .Sections) }}
          {{ end}}
          {{ $pages := (.Scratch.Get "pages") }}

        {{ if eq .Site.Params.ordersectionsby "title"}}
          {{ range $pages.ByTitle }}
            {{ if and .Params.hidden (not $.showhidden) }}
            {{ else}}
            {{ template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks }}
            {{ end}}
          {{ end}}
        {{ else}}
          {{ range $pages.ByWeight }}
            {{ if and .Params.hidden (not $.showhidden) }}
            {{ else}}
            {{ template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks }}
            {{ end}}
          {{ end}}
        {{ end}}
        </ul>
      {{ end}}
    </li>
{{ else}}
    {{ if not .Params.Hidden }}
      <li data-nav-id="{{.URL}}" class="dd-item
     {{ if eq .URL $currentNode.URL}} active{{end -}}
      ">
        <a href="{{ .RelPermalink}}">
          <span>{{safeHTML .Params.Pre}}{{.Title}}{{safeHTML .Params.Post}}</span>
          {{ if $showvisitedlinks}}<i class="material-icons">check</i></i>{{end}}
        </a>
    </li>
    </ul>
     {{ end}}
  {{ end}}
 {{ end}}
{{ end}}
